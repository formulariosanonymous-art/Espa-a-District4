<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espa√±a District | Sistema de Normas</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2575fc;
            --accent: #ff8a00;
            --bg: #f4f7fa;
            --white: #ffffff;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: #333; }

        /* HEADER & SIDEBAR */
        .header-controls { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .menu-icon { background: var(--white); width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow); cursor: pointer; border: none; font-size: 20px; }
        
        .sidebar { position: fixed; right: -320px; top: 0; width: 280px; height: 100%; background: var(--white); z-index: 999; transition: 0.4s; padding: 40px 20px; box-shadow: -5px 0 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .sidebar.open { right: 0; }
        .nav-content { flex-grow: 1; margin-top: 20px; }
        .nav-item { padding: 15px; border-radius: 10px; margin-bottom: 8px; cursor: pointer; font-weight: 600; color: #666; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover { background: #f0f0f0; }
        .nav-item.active { background: #eef2ff; color: var(--primary); }

        /* SECCI√ìN INFERIOR SIDEBAR */
        .sidebar-footer { border-top: 1px solid #eee; padding-top: 20px; }
        .info-box { background: #5865F2; color: white; padding: 15px; border-radius: 12px; text-decoration: none; display: flex; flex-direction: column; gap: 5px; transition: 0.3s; }
        .info-box:hover { background: #4752c4; transform: translateY(-2px); }

        /* VISTAS */
        .view { display: none; flex-direction: column; align-items: center; padding: 40px 20px; min-height: 100vh; box-sizing: border-box; }
        .view.active { display: flex; }

        /* ADMIN PANEL */
        .admin-container { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 25px; }
        .admin-card { background: white; padding: 25px; border-radius: 20px; box-shadow: var(--shadow); border-top: 5px solid #ddd; }
        .admin-card.editing { border-top-color: var(--primary); background: #f8faff; }
        
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #eee; border-radius: 10px; background: #fafafa; font-family: inherit; box-sizing: border-box; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.3s; margin-top: 5px; }
        .btn-add { background: #2ecc71; color: white; }
        .btn-save { background: var(--primary); color: white; }
        .btn-cancel { background: #eee; color: #666; margin-top: 10px; }

        /* GESTI√ìN LISTA */
        .manage-item { background: white; padding: 12px; border-radius: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; }
        
        /* P√öBLICO */
        .section-button { width: 100%; max-width: 450px; padding: 20px; border-radius: 15px; margin-bottom: 10px; border: none; font-weight: 800; color: white; cursor: pointer; display: flex; justify-content: space-between; box-shadow: var(--shadow); }
        .norms-container { width: 100%; max-width: 450px; max-height: 0; overflow: hidden; transition: 0.4s; }
        .norm-card { background: white; padding: 15px; border-radius: 15px; margin-bottom: 10px; border-left: 4px solid var(--primary); }
    </style>
</head>
<body>

    <div class="header-controls">
        <button class="menu-icon" onclick="toggleSidebar()">‚ò∞</button>
    </div>

    <div class="sidebar" id="sidebar">
        <h2 style="margin:0; color:var(--primary);">Espa√±a District</h2>
        
        <div class="nav-content">
            <div class="nav-item" onclick="navigate('home')">üè† Inicio</div>
            <div class="nav-item" onclick="navigate('public')">üìÑ Ver Normas</div>
            <div class="nav-item" onclick="navigate('admin')">‚öôÔ∏è Panel Admin</div>
        </div>

        <div class="sidebar-footer">
            <p style="margin: 0 0 10px 5px; font-weight: 700; color: #999; font-size: 12px; text-transform: uppercase;">Informaci√≥n</p>
            <a href="https://discord.gg/Rp5fumwpUK" target="_blank" class="info-box">
                <span style="font-weight: 800; font-size: 14px;">Servidor de Discord</span>
                <span style="font-size: 11px; opacity: 0.9;">√önete a nuestra comunidad oficial</span>
            </a>
        </div>
    </div>

    <section id="view-home" class="view active">
        <img src="https://i.postimg.cc/Jz743TdL/e77730807aec5f2a5360ef9b416e25f7.png" width="120">
        <h1 style="font-size: 32px;">Espa√±a District</h1>
        <button class="btn btn-save" style="width:auto; padding:15px 40px; border-radius:30px;" onclick="navigate('public')">Explorar Normativas</button>
    </section>

    <section id="view-public" class="view">
        <input type="text" id="search" style="max-width:450px; margin-bottom:20px; padding:15px; border-radius:12px; border:none; width:100%; box-shadow: var(--shadow);" placeholder="üîç Buscar norma o n√∫mero..." onkeyup="renderAll()">
        <div id="content-public" style="width: 100%; display: flex; flex-direction: column; align-items: center;"></div>
    </section>

    <section id="view-admin" class="view">
        <div class="admin-container">
            <div class="admin-card" id="card-sec">
                <h3 id="title-sec">1. Crear/Editar Secci√≥n <span id="badge-sec" style="display:none; color:var(--primary); font-size:10px;">[MODO EDICI√ìN]</span></h3>
                <input type="text" id="in-sec-name" placeholder="Ej: Normativa Policial">
                <button class="btn btn-add" id="btn-sec-action" onclick="saveSection()">+ Crear Secci√≥n</button>
                <button class="btn btn-cancel" id="btn-sec-cancel" style="display:none;" onclick="cancelEdit()">Cancelar</button>
            </div>

            <div class="admin-card" id="card-norm">
                <h3 id="title-norm">2. Crear/Editar Norma <span id="badge-norm" style="display:none; color:var(--primary); font-size:10px;">[MODO EDICI√ìN]</span></h3>
                <select id="in-norm-target"></select>
                <input type="text" id="in-norm-title" placeholder="T√≠tulo de la norma">
                <div style="margin: 5px 0;">
                    <button onclick="wrap('b')"><b>B</b></button> <button onclick="wrap('i')"><i>I</i></button> <button onclick="wrap('u')"><u>U</u></button> <button onclick="wrap('s')"><s>S</s></button>
                </div>
                <textarea id="in-norm-desc" rows="4" placeholder="Escribe aqu√≠ las reglas..."></textarea>
                <label style="font-size:11px; font-weight:700;">Subir Imagen:</label>
                <input type="file" id="in-norm-file" accept="image/*">
                <button class="btn btn-add" id="btn-norm-action" style="background:var(--primary);" onclick="saveNorma()">+ Guardar Norma</button>
                <button class="btn btn-cancel" id="btn-norm-cancel" style="display:none;" onclick="cancelEdit()">Cancelar</button>
            </div>

            <div class="admin-card">
                <h3>3. Gesti√≥n de Contenido</h3>
                <div id="admin-list"></div>
            </div>
        </div>
    </section>

    <script>
        const WEBHOOK = "https://discord.com/api/webhooks/1474271939697705111/beTyfVivPaHokNQvnPw5SSkaY74Yb6C1SCKBNpj-SM2EfXBBhNT-YtvlecFYCkl4vAR4";
        let db = JSON.parse(localStorage.getItem('esp_db_v5')) || [];
        let editState = { s: null, n: null };

        // RESTAURACI√ìN DE LOGS CON EMBED
        async function sendLog(title, description, color) {
            const embed = {
                title: title,
                description: description,
                color: color || 3447003,
                timestamp: new Date(),
                footer: { text: "Sistema de Logs | Espa√±a District" }
            };
            fetch(WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ embeds: [embed] })
            });
        }

        function save() {
            localStorage.setItem('esp_db_v5', JSON.stringify(db));
            renderAll();
            renderAdmin();
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        function navigate(v) {
            document.querySelectorAll('.view').forEach(s => s.classList.remove('active'));
            document.getElementById('view-' + v).classList.add('active');
            toggleSidebar();
        }

        function wrap(tag) {
            const area = document.getElementById('in-norm-desc');
            area.value = area.value.substring(0, area.selectionStart) + `<${tag}>` + area.value.substring(area.selectionStart, area.selectionEnd) + `</${tag}>` + area.value.substring(area.selectionEnd);
        }

        async function saveSection() {
            const name = document.getElementById('in-sec-name').value;
            if(!name) return;
            if(editState.s !== null && editState.n === null) {
                db[editState.s].name = name;
                sendLog("üìÇ Secci√≥n Editada", `Se cambi√≥ el nombre a: **${name}**`, 16753920);
            } else {
                db.push({ name, norms: [] });
                sendLog("üìÇ Nueva Secci√≥n", `Se cre√≥ la categor√≠a: **${name}**`, 3066993);
            }
            cancelEdit(); save();
        }

        async function saveNorma() {
            const sIdx = document.getElementById('in-norm-target').value;
            const title = document.getElementById('in-norm-title').value;
            const desc = document.getElementById('in-norm-desc').value;
            const file = document.getElementById('in-norm-file').files[0];
            let img = (editState.s !== null && editState.n !== null) ? db[editState.s].norms[editState.n].img : "";

            const finalize = (image) => {
                if(editState.s !== null && editState.n !== null) {
                    db[editState.s].norms[editState.n] = { title, desc, img: image };
                    sendLog("üìÑ Norma Editada", `Norma: **${title}** en **${db[editState.s].name}**`, 16753920);
                } else {
                    db[sIdx].norms.push({ title, desc, img: image });
                    sendLog("üìÑ Nueva Norma", `T√≠tulo: **${title}**\nSecci√≥n: **${db[sIdx].name}**`, 3447003);
                }
                cancelEdit(); save();
            };

            if(file) {
                const reader = new FileReader();
                reader.onload = () => finalize(reader.result);
                reader.readAsDataURL(file);
            } else { finalize(img); }
        }

        function editItem(s, n = null) {
            editState = { s, n };
            if(n === null) {
                document.getElementById('in-sec-name').value = db[s].name;
                document.getElementById('card-sec').classList.add('editing');
                document.getElementById('badge-sec').style.display = 'inline';
                document.getElementById('btn-sec-action').innerText = "Actualizar Secci√≥n";
                document.getElementById('btn-sec-cancel').style.display = 'block';
            } else {
                document.getElementById('in-norm-target').value = s;
                document.getElementById('in-norm-title').value = db[s].norms[n].title;
                document.getElementById('in-norm-desc').value = db[s].norms[n].desc;
                document.getElementById('card-norm').classList.add('editing');
                document.getElementById('badge-norm').style.display = 'inline';
                document.getElementById('btn-norm-action').innerText = "Actualizar Norma";
                document.getElementById('btn-norm-cancel').style.display = 'block';
            }
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function cancelEdit() {
            editState = { s: null, n: null };
            document.querySelectorAll('.admin-card').forEach(c => c.classList.remove('editing'));
            document.querySelectorAll('[id$="-cancel"], .tag-edit').forEach(e => e.style.display = 'none');
            document.getElementById('btn-sec-action').innerText = "+ Crear Secci√≥n";
            document.getElementById('btn-norm-action').innerText = "+ A√±adir Norma";
            document.getElementById('in-sec-name').value = "";
            document.getElementById('in-norm-title').value = "";
            document.getElementById('in-norm-desc').value = "";
            document.getElementById('in-norm-file').value = "";
        }

        function deleteItem(s, n = null) {
            if(confirm("¬øEst√°s seguro?")) {
                const item = n === null ? db[s].name : db[s].norms[n].title;
                sendLog("üóëÔ∏è Elemento Eliminado", `Se elimin√≥: **${item}**`, 15158332);
                if(n === null) db.splice(s, 1);
                else db[s].norms.splice(n, 1);
                save();
            }
        }

        function renderAdmin() {
            const list = document.getElementById('admin-list');
            const select = document.getElementById('in-norm-target');
            list.innerHTML = ""; select.innerHTML = "";
            db.forEach((s, si) => {
                select.innerHTML += `<option value="${si}">${s.name}</option>`;
                list.innerHTML += `<div class="manage-item"><b>üìÅ ${s.name}</b><div><button onclick="editItem(${si})">‚úèÔ∏è</button> <button onclick="deleteItem(${si})">üóëÔ∏è</button></div></div>`;
                s.norms.forEach((n, ni) => {
                    list.innerHTML += `<div class="manage-item" style="margin-left:25px; background:#f9f9f9; font-size:13px;"><span>${ni+1}. ${n.title}</span><div><button onclick="editItem(${si}, ${ni})">‚úèÔ∏è</button> <button onclick="deleteItem(${si}, ${ni})">üóëÔ∏è</button></div></div>`;
                });
            });
        }

        function renderAll() {
            const cont = document.getElementById('content-public');
            const q = document.getElementById('search').value.toLowerCase();
            cont.innerHTML = "";
            db.forEach((s, i) => {
                const filtered = s.norms.filter(n => n.title.toLowerCase().includes(q) || n.desc.toLowerCase().includes(q));
                if(s.name.toLowerCase().includes(q) || filtered.length > 0) {
                    cont.innerHTML += `
                        <button class="section-button" style="background:linear-gradient(135deg,#2575fc,#6a11cb);" onclick="toggleSec(${i})">
                            ${s.name} <span>‚ñº</span>
                        </button>
                        <div class="norms-container" id="sec-${i}">
                            ${filtered.map(n => `
                                <div class="norm-card">
                                    <b style="color:var(--primary);">${s.norms.indexOf(n)+1}. ${n.title}</b>
                                    <p style="font-size:14px; margin-top:8px; line-height:1.6;">${n.desc}</p>
                                    ${n.img ? `<img src="${n.img}" style="width:100%; border-radius:10px; margin-top:10px;">` : ''}
                                </div>
                            `).join('')}
                        </div>`;
                }
            });
        }

        function toggleSec(i) {
            const el = document.getElementById('sec-' + i);
            const isOpen = el.style.maxHeight !== '0px' && el.style.maxHeight !== '';
            document.querySelectorAll('.norms-container').forEach(c => c.style.maxHeight = '0px');
            if(!isOpen) el.style.maxHeight = '3000px';
        }

        renderAll(); renderAdmin();
    </script>
</body>
</html>
